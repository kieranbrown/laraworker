#!/bin/bash
set -euo pipefail

# Filter staged files by extension
PHP_FILES=()
if [ -n "${FUEL_STAGED_FILES:-}" ]; then
    while IFS= read -r file; do
        [ -z "$file" ] && continue
        case "$file" in
            *.php) [ -e "$file" ] && PHP_FILES+=("$file") ;;
        esac
    done <<< "$FUEL_STAGED_FILES"
fi

# Exit early if no PHP files are staged
[ "${#PHP_FILES[@]}" -eq 0 ] && { echo "All quality gates passed"; exit 0; }

# Auto-fix formatting with Pint (silent, no colors)
if ! ./vendor/bin/pint --quiet --no-ansi "${PHP_FILES[@]}" 2>&1; then
    echo "Pint"
    ./vendor/bin/pint --no-ansi "${PHP_FILES[@]}" 2>&1 || true
    exit 1
fi

# Restage auto-fixed files so commit includes fixes
git add -- "${PHP_FILES[@]}" 2>/dev/null || true

# Run tests with Pest (no colors, compact output only on failure)
if ! ./vendor/bin/pest --colors=never --no-coverage 2>&1; then
    echo "Pest"
    ./vendor/bin/pest --colors=never --no-coverage 2>&1 || true
    exit 1
fi

echo "All quality gates passed"
