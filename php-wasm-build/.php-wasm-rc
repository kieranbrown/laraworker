#!/usr/bin/env php-wasm

# Absolute minimum PHP WASM build for Cloudflare Workers.
# Built from seanmorris/php-wasm sm-8.5 branch.
# OPcache statically linked — provides ~3x warm request speedup.

PHP_VERSION=8.5
# PHP_BRANCH is overridden by the sm-8.5 Makefile to php-8.5.2 (its supported version).
# This value is informational; the Makefile sets PHP_VERSION_FULL=8.5.2 internally.
PHP_BRANCH=php-8.5.2

# Build source: seanmorris/php-wasm (sm-8.5 branch)
# Branch URL: https://github.com/seanmorris/php-wasm/tree/sm-8.5
# Builder image: seanmorris/phpwasm-emscripten-builder:latest

# Static linking only — no dynamic library support.
# Produces a single .wasm file with everything baked in.
MAIN_MODULE=0

# Maximum size optimization
OPTIMIZE=z

# Async support (needed for CGI request handling)
ASYNCIFY=1

# No debug overhead
ASSERTIONS=0
SYMBOLS=0
WITH_SOURCEMAPS=0

# Compression
GZIP=1

# ── OPcache: enabled ──
# OPcache is bundled into PHP core and enabled by default in sm-8.5 branch.
# The sm-8.5 Makefile passes --disable-opcache-jit automatically (JIT not
# useful in single-threaded WASM execution).
# Memory allocation: uses mmap() within WASM linear memory (no shmget).
# Persists across requests in warm Cloudflare Workers isolates.
# Expected size increase: ~150-250 KB gzipped vs no-opcache build.
WITH_OPCACHE=1

# ── Extensions: ALL disabled ──
# These are optional PHP extensions — all disabled to minimise binary size.
# OPcache is NOT listed here as it is a bundled (always-compiled) extension.

WITH_BCMATH=0
WITH_CALENDAR=0
WITH_CTYPE=0
WITH_EXIF=0
WITH_FILTER=0
WITH_TOKENIZER=0
WITH_VRZNO=0

# WITH_SESSION MUST be 1: the pib (PHP-in-Browser) extension references ps_globals
# from the session module. Disabling session causes an undefined symbol link error.
WITH_SESSION=1

WITH_PHAR=0
WITH_LIBXML=0
WITH_DOM=0
WITH_XML=0
WITH_SIMPLEXML=0
WITH_ICONV=0
WITH_SQLITE=0
WITH_LIBZIP=0
WITH_ZLIB=0
WITH_GD=0
WITH_LIBPNG=0
WITH_FREETYPE=0
WITH_LIBJPEG=0
WITH_LIBWEBP=0
WITH_YAML=0
WITH_TIDY=0
WITH_MBSTRING=0
WITH_ONIGURUMA=0
WITH_OPENSSL=0
WITH_INTL=0
