#!/usr/bin/env php-wasm

# Absolute minimum PHP WASM build for Cloudflare Workers.
# Built from seanmorris/php-wasm sm-8.5 branch.
# OPcache statically linked — provides ~3x warm request speedup.

PHP_VERSION=8.5
# PHP_BRANCH is overridden by the sm-8.5 Makefile to php-8.5.2 (its supported version).
# This value is informational; the Makefile sets PHP_VERSION_FULL=8.5.2 internally.
PHP_BRANCH=php-8.5.2

# Build source: seanmorris/php-wasm (sm-8.5 branch)
# Branch URL: https://github.com/seanmorris/php-wasm/tree/sm-8.5
# Builder image: seanmorris/phpwasm-emscripten-builder:latest

# Static linking only — no dynamic library support.
# Produces a single .wasm file with everything baked in.
MAIN_MODULE=0

# Maximum size optimization
OPTIMIZE=z

# Async support (needed for CGI request handling)
ASYNCIFY=1

# No debug overhead
ASSERTIONS=0
SYMBOLS=0
WITH_SOURCEMAPS=0

# Compression
GZIP=1

# ── OPcache: enabled ──
# PHP 8.5 makes OPcache a required, non-optional extension (always compiled).
# The sm-8.5 Makefile passes --disable-opcache-jit automatically.
#
# Emscripten cross-compilation quirk: the autoconf mmap(MAP_ANON) shared memory
# test can't execute, so it defaults to "no" — leaving OPcache without a shared
# memory backend (compiled but non-functional). build.sh applies patches from
# patches/opcache-wasm-support.sh to force php_cv_shm_mmap_anon=yes and add
# a missing <unistd.h> include. Emscripten's mmap() allocates from the WASM
# linear heap, which is sufficient for single-process OPcache.
#
# Same approach as WordPress Playground (PR #2400, July 2025).
# Opcodes persist across requests in warm Cloudflare Workers isolates.
# Expected size increase: ~150-250 KB gzipped vs no-opcache build.
WITH_OPCACHE=1

# ── PDO + Cloudflare D1 (pdo-cfd1) ──
# pdo-cfd1 bridges PHP's PDO to Cloudflare D1's JavaScript API via EM_ASM interop.
# Enables `new PDO('cfd1:BINDING_NAME')` in PHP — Laravel Eloquent works with D1.
# The build system (packages/pdo-cfd1/pre.mak) clones the extension source and adds
# --enable-pdo-cfd1 to PHP configure flags. PDO core is auto-enabled as a dependency.
# Expected binary size impact: ~50-100 KB gzipped (lightweight C code, ~4 source files).
WITH_PDO_CFD1=1

# ── Extensions: ALL disabled ──
# These are optional PHP extensions — all disabled to minimise binary size.
# OPcache is NOT listed here as it is a bundled (always-compiled) extension.

WITH_BCMATH=0
WITH_CALENDAR=0
WITH_CTYPE=0
WITH_EXIF=0
WITH_FILTER=0
WITH_TOKENIZER=0

# vrzno (JS<->PHP bridge) is required by pdo-cfd1 for zval/JS type conversion.
# It provides vrzno_fetch_object() and Module.jsToZval()/zvalToJS() interop.
WITH_VRZNO=1

# WITH_SESSION MUST be 1: the pib (PHP-in-Browser) extension references ps_globals
# from the session module. Disabling session causes an undefined symbol link error.
WITH_SESSION=1

WITH_PHAR=0
WITH_LIBXML=0
WITH_DOM=0
WITH_XML=0
WITH_SIMPLEXML=0
WITH_ICONV=0
WITH_SQLITE=0
WITH_LIBZIP=0
WITH_ZLIB=0
WITH_GD=0
WITH_LIBPNG=0
WITH_FREETYPE=0
WITH_LIBJPEG=0
WITH_LIBWEBP=0
WITH_YAML=0
WITH_TIDY=0
WITH_MBSTRING=0
WITH_ONIGURUMA=0
WITH_OPENSSL=0
WITH_INTL=0

# ── Memory: fixed 64 MB ──
# Cloudflare Workers has a 128 MB memory budget. We use a fixed 64 MB WASM
# linear memory (no growth) to stay well under budget, leaving ~64 MB headroom
# for JS heap overhead and application data.
#
# Fixed memory prevents overshooting the budget when auto-expansion would
# push combined WASM + JS memory past CF Workers' limit. The upstream Makefile
# hardcodes ALLOW_MEMORY_GROWTH=1 — we override it with ALLOW_MEMORY_GROWTH=0.
# The linker requires ~35 MB minimum (TOTAL_STACK=32MB + static data + heap).
INITIAL_MEMORY=67108864
ALLOW_MEMORY_GROWTH=0

# ── Function table: fixed size ──
# ALLOW_TABLE_GROWTH=1 adds ~2 MB memory overhead during cold starts, pushing
# combined WASM + JS heap past Cloudflare Workers' 128 MB limit → Error 1102.
# The "table index out of bounds" crashes were caused by profiling code that
# manipulated spl_autoload internals (removed in 33bc88e1), not by table
# exhaustion. With that code removed, the fixed-size table is sufficient.
# Also in build.sh: remove -sALLOW_TABLE_GROWTH=1 from EXTRA_FLAGS if present.
ALLOW_TABLE_GROWTH=0
